import { useCallback } from 'react';
import { useSmithers } from '../components/SmithersProvider.js';
const DEFAULT_WAIT_MS = 5 * 60 * 1000;
const DEFAULT_STALE_MS = 15 * 60 * 1000;
const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
const isPrecommitFailure = (message) => {
    return /(pre-commit|precommit|hook)/i.test(message);
};
export function useCommitWithRetry(options = {}) {
    const smithers = useSmithers();
    const waitMs = options.waitMs ?? DEFAULT_WAIT_MS;
    const staleMs = options.staleMs ?? DEFAULT_STALE_MS;
    return useCallback(async (commitOperation) => {
        try {
            return await commitOperation();
        }
        catch (err) {
            const errorObj = err instanceof Error ? err : new Error(String(err));
            const stderr = err.stderr ?? '';
            const stdout = err.stdout ?? '';
            const combined = [errorObj.message, stderr, stdout].filter(Boolean).join('\n');
            if (!isPrecommitFailure(combined)) {
                throw errorObj;
            }
            const agentId = smithers.db.agents.current()?.id ?? 'system';
            const decision = smithers.db.buildState.handleBrokenBuild(agentId, { waitMs, staleMs });
            if (decision.shouldFix) {
                await options.onFixRequested?.({ state: decision.state, error: errorObj });
                const result = await commitOperation();
                smithers.db.buildState.markFixed();
                return result;
            }
            await sleep(decision.waitMs);
            const result = await commitOperation();
            smithers.db.buildState.markFixed();
            return result;
        }
    }, [smithers, waitMs, staleMs, options.onFixRequested]);
}
//# sourceMappingURL=useCommitWithRetry.js.map