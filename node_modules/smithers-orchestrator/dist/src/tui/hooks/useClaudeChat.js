// Hook for Claude-powered chat interface
// Gracefully degrades when ANTHROPIC_API_KEY is not set
import { useCallback, useMemo } from 'react';
import { createClaudeAssistant } from '../services/claude-assistant.js';
import { readTuiState, useTuiState } from '../state.js';
const MESSAGES_KEY = 'tui:chat:messages';
const LOADING_KEY = 'tui:chat:loading';
const ERROR_KEY = 'tui:chat:error';
const EMPTY_MESSAGES = [];
export function useClaudeChat(db) {
    const [messages, setMessages] = useTuiState(MESSAGES_KEY, EMPTY_MESSAGES);
    const [isLoading, setIsLoading] = useTuiState(LOADING_KEY, false);
    const [error, setError] = useTuiState(ERROR_KEY, null);
    // Check if API key is available
    const isAvailable = !!process.env['ANTHROPIC_API_KEY'];
    const assistant = useMemo(() => createClaudeAssistant(db), [db]);
    const sendMessage = useCallback(async (content) => {
        if (!isAvailable) {
            setError('ANTHROPIC_API_KEY not set. Claude chat is unavailable.');
            return;
        }
        const userMessage = {
            role: 'user',
            content,
            timestamp: new Date().toISOString()
        };
        const history = readTuiState(MESSAGES_KEY, EMPTY_MESSAGES);
        const nextMessages = [...history, userMessage];
        setMessages(nextMessages);
        setIsLoading(true);
        setError(null);
        try {
            const response = await assistant.chat(nextMessages);
            const assistantMessage = {
                role: 'assistant',
                content: response,
                timestamp: new Date().toISOString()
            };
            setMessages(prev => [...prev, assistantMessage]);
        }
        catch (e) {
            setError(e instanceof Error ? e.message : 'Failed to get response');
        }
        finally {
            setIsLoading(false);
        }
    }, [assistant, isAvailable, setError, setIsLoading, setMessages]);
    const clearHistory = useCallback(() => {
        setMessages([]);
        setError(null);
    }, [setMessages, setError]);
    return {
        messages,
        isLoading,
        error,
        isAvailable,
        sendMessage,
        clearHistory
    };
}
//# sourceMappingURL=useClaudeChat.js.map