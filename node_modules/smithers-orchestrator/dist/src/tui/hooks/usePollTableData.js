import { useMemo } from 'react';
import { useEffectOnValueChange } from '../../reconciler/hooks.js';
import { useTuiState } from '../state.js';
const ALLOWED_TABLES = [
    'executions', 'phases', 'agents', 'tool_calls', 'human_interactions',
    'render_frames', 'tasks', 'steps', 'reports', 'memories',
    'state', 'transitions', 'artifacts', 'commits', 'snapshots', 'reviews'
];
const EMPTY_COLUMNS = [];
const EMPTY_DATA = [];
export function usePollTableData(db, tableName) {
    const columnsKey = `tui:table:${tableName}:columns`;
    const dataKey = `tui:table:${tableName}:rows`;
    const [columns, setColumns] = useTuiState(columnsKey, EMPTY_COLUMNS);
    const [data, setData] = useTuiState(dataKey, EMPTY_DATA);
    const pollKey = useMemo(() => ({ db, tableName }), [db, tableName]);
    useEffectOnValueChange(pollKey, () => {
        if (!ALLOWED_TABLES.includes(tableName)) {
            setColumns(EMPTY_COLUMNS);
            setData(EMPTY_DATA);
            return;
        }
        const poll = () => {
            try {
                const pragmaResult = db.query(`PRAGMA table_info(${tableName})`);
                setColumns(pragmaResult.map(r => r.name));
                const tableData = db.query(`SELECT * FROM ${tableName} ORDER BY rowid DESC LIMIT 100`);
                setData(tableData);
            }
            catch (err) {
                console.debug('[usePollTableData] Polling error:', err);
                setColumns(EMPTY_COLUMNS);
                setData(EMPTY_DATA);
            }
        };
        poll();
        const interval = setInterval(poll, 500);
        return () => clearInterval(interval);
    }, [setColumns, setData, tableName, db]);
    return { columns, data };
}
//# sourceMappingURL=usePollTableData.js.map