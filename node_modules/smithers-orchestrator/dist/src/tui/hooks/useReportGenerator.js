// Hook for auto-generating 10-minute reports
import { useCallback } from 'react';
import { generateReport } from '../services/report-generator.js';
import { useEffectOnValueChange } from '../../reconciler/hooks.js';
import { useTuiState } from '../state.js';
const REPORT_INTERVAL_MS = 10 * 60 * 1000; // 10 minutes
const REPORTS_KEY = 'tui:reports:list';
const GENERATING_KEY = 'tui:reports:generating';
const LAST_GENERATED_KEY = 'tui:reports:lastGeneratedAt';
const EMPTY_REPORTS = [];
export function useReportGenerator(db) {
    const [reports, setReports] = useTuiState(REPORTS_KEY, EMPTY_REPORTS);
    const [isGenerating, setIsGenerating] = useTuiState(GENERATING_KEY, false);
    const [lastGeneratedAt, setLastGeneratedAt] = useTuiState(LAST_GENERATED_KEY, null);
    const generateNow = useCallback(async () => {
        setIsGenerating(true);
        try {
            const report = await generateReport(db);
            if (report) {
                setReports(prev => [report, ...prev]);
                setLastGeneratedAt(new Date().toISOString());
            }
        }
        catch (err) {
            console.debug('[useReportGenerator] Generate error:', err);
        }
        finally {
            setIsGenerating(false);
        }
    }, [db, setIsGenerating, setReports, setLastGeneratedAt]);
    useEffectOnValueChange(db, () => {
        const loadReports = () => {
            try {
                const dbReports = db.query("SELECT * FROM reports WHERE type = 'auto_summary' ORDER BY created_at DESC LIMIT 50");
                setReports(dbReports);
            }
            catch (err) {
                console.debug('[useReportGenerator] Load error:', err);
            }
        };
        loadReports();
        const loadInterval = setInterval(loadReports, 5000);
        const generateInterval = setInterval(() => {
            generateNow();
        }, REPORT_INTERVAL_MS);
        return () => {
            clearInterval(loadInterval);
            clearInterval(generateInterval);
        };
    }, [db, generateNow, setReports]);
    return {
        reports,
        isGenerating,
        lastGeneratedAt,
        generateNow
    };
}
//# sourceMappingURL=useReportGenerator.js.map