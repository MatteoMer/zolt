import { useCallback } from 'react';
import { ReactiveDatabase } from '../reactive-sqlite/index.js';
import { useQueryValue } from '../reactive-sqlite/index.js';
const tuiDb = new ReactiveDatabase(':memory:');
tuiDb.exec('CREATE TABLE IF NOT EXISTS tui_state (key TEXT PRIMARY KEY, value TEXT)');
function parseValue(raw, fallback) {
    if (!raw)
        return fallback;
    try {
        return JSON.parse(raw);
    }
    catch {
        return fallback;
    }
}
export function readTuiState(key, fallback) {
    const row = tuiDb.queryOne('SELECT value FROM tui_state WHERE key = ?', [key]);
    return row ? parseValue(row.value, fallback) : fallback;
}
function writeTuiState(key, value) {
    const jsonValue = JSON.stringify(value);
    tuiDb.run('INSERT INTO tui_state (key, value) VALUES (?, ?) ON CONFLICT(key) DO UPDATE SET value = ?', [key, jsonValue, jsonValue]);
}
export function useTuiState(key, fallback) {
    const { data: raw } = useQueryValue(tuiDb, 'SELECT value FROM tui_state WHERE key = ?', [key]);
    const value = parseValue(raw, fallback);
    const setValue = useCallback((next) => {
        const resolved = typeof next === 'function'
            ? next(readTuiState(key, fallback))
            : next;
        writeTuiState(key, resolved);
    }, [key, fallback]);
    return [value, setValue];
}
export function useTuiStateValue(key, fallback) {
    return useTuiState(key, fallback)[0];
}
//# sourceMappingURL=state.js.map